---
title: "Resum de resultats"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: 
  pdf_document:
    latex_engine: xelatex
params:
  reactive_df: NA
  chosen_geo_type: NA
  chosen_geo: NA
  chosen_any: NA
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage[table]{xcolor}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{caption}
  - \usepackage{fontspec}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 0.8
)

library(dplyr)
library(kableExtra)


paste0("Resum: ", params$chosen_geo, " (", params$chosen_geo_type, "), ", params$chosen_any)

# Prepare data for PDF
df_for_pdf <- params$reactive_df %>%
  mutate(variacio = case_when(
    trend_icona == "up" ~ "↑",
    trend_icona == "down" ~ "↓",
    trend_icona %in% c("betterup", "betterdown") ~ "↑↓ (millora)",
    trend_icona %in% c("worseup", "worsedown") ~ "↑↓ (empitjora)",
    trend_icona == "new" ~ "nou",
    trend_icona == "unchanged" ~ "=",
    TRUE ~ ""
  )) %>%
  select(
    ambit,
    dimensio,
    indicador,
    subcategoria = subtipologia,
    resultat,
    mitjana,
    mesura,
    variacio
  ) %>%
  arrange(ambit, dimensio)

# Create the table
df_for_pdf %>%
  kbl(
    format = "latex",
    longtable = TRUE,
    booktabs = TRUE,
    col.names = c(
      "Àmbit",
      "Dimensió",
      "Indicador",
      "Subcategoria",
      params$chosen_geo,
      "Catalunya",
      "Unitat",
      "Variació"
    ),
    align = c('l', 'l', 'l', 'l', 'r', 'r', 'c', 'c')
  ) %>%
  kable_styling(
    latex_options = c("repeat_header", "striped"),
    font_size = 8,
    position = "left",
    full_width = TRUE
  ) %>%
  collapse_rows(columns = 1:2, valign = "top")

```
